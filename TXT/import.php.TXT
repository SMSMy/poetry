<?php
set_time_limit(0);
require 'config.php';
require 'functions.php'; // ูุณุชุฏุนู ุงูุฏูุงู ุงูุฌุฏูุฏุฉ

set_time_limit(600);
ob_implicit_flush(true); ob_end_flush();

$dir = __DIR__ . '/json_data';
$files = glob("$dir/*.json");
if (empty($files)) die('ุฎุทุฃ: ูุง ุชูุฌุฏ ูููุงุช JSON ููุงุณุชูุฑุงุฏ.');

echo "<h3>ุจุฏุก ุงุณุชูุฑุงุฏ " . count($files) . " ููู ุดุงุนุฑ...</h3><hr>";
echo "<div style='font-family: monospace; line-height: 1.8; font-size: 14px;'>";

foreach ($files as $file) {
    // =====>>> ุงูุงุนุชูุงุฏ ุนูู ุงุณู ุงูููู ููุตุฏุฑ ููุงุณู <<<=====
    $poetName = basename($file, '.json');
    // ุชูุธูู ุฅุถุงูู ูุฅุฒุงูุฉ ุฃู ุดูุก ูุซู (2) ูู ููุงูุฉ ุงูุงุณู
    $poetName = preg_replace('/ \(\d+\)$/', '', $poetName);
    $poetName = trim($poetName);
    
    echo "<div><strong style='color: #007bff;'>-- ุฌุงุฑู ูุนุงูุฌุฉ: $poetName</strong></div>"; flush();

    $data = json_decode(file_get_contents($file), true);
    if (!isset($data['info']) || empty(trim($data['info']))) { 
        echo "<div style='color: #dc3545;'>ย ย โณ ุชุฎุทูุ ููู JSON ูุงุฑุบ.</div><hr>"; continue;
    }

    // ูุญุงูู ุงูุญุตูู ุนูู ุงูุนุตุฑ ูู ุงููุงุฆูุฉ ุงูุฏูููุฉ
    $poetEra = deduce_era($poetName);

    if ($poetEra === null) {
        echo "<div style='color: #fd7e14;'>ย ย โณ <strong>ูุดู!</strong> ูู ูุชู ุงูุนุซูุฑ ุนูู ุนุตุฑ ููุดุงุนุฑ `$poetName` ูู ููู `era_data.php`.</div>";
        echo "<hr>";
        continue;
    }

    $poetInfoRaw = trim($data['info']);
    
    $stmt = $pdo->prepare("SELECT id FROM poets WHERE name = ?");
    $stmt->execute([$poetName]);
    $poetId = $stmt->fetchColumn();

    if (!$poetId) {
        $stmt_insert = $pdo->prepare("INSERT INTO poets (name, era, info) VALUES (?, ?, ?)");
        $stmt_insert->execute([$poetName, $poetEra, $poetInfoRaw]);
        $poetId = $pdo->lastInsertId();
        echo "<div style='color: #28a745;'>ย ย โ <strong>ูุฌุงุญ:</strong> ุดุงุนุฑ ุฌุฏูุฏ ุฃูุถูู.</div>";
    } else {
        // ุชุญุฏูุซ ุงูุจูุงูุงุช ูู ุญุงู ูุฌูุฏ ุงูุดุงุนุฑ ูุณุจููุง
        $stmt_update = $pdo->prepare("UPDATE poets SET era = ?, info = ? WHERE id = ?");
        $stmt_update->execute([$poetEra, $poetInfoRaw, $poetId]);
        echo "<div style='color: #17a2b8;'>ย ย โน๏ธ <strong>ูุฌุงุญ:</strong> ุงูุดุงุนุฑ ููุฌูุฏุ ุชู ุชุญุฏูุซ ุจูุงูุงุชู.</div>";
    }

    // ุญุฐู ุงููุตุงุฆุฏ ุงููุฏููุฉ ูุถูุงู ุนุฏู ุงูุชูุฑุงุฑ
    $stmt_delete = $pdo->prepare("DELETE FROM poems WHERE poet_id = ?");
    $stmt_delete->execute([$poetId]);

    $poemCount = 0;
    if (is_array($data)) {
        foreach ($data as $key => $poem_data) {
            if (is_numeric($key) && isset($poem_data['poem']) && !empty(trim($poem_data['poem']))) {
                $first_line = explode("\n", trim($poem_data['poem']))[0];
                $title = explode('//', $first_line)[0];

                $stmt_poem = $pdo->prepare("INSERT INTO poems (poet_id, title, poem, bahr, qafiya) VALUES (?, ?, ?, ?, ?)");
                $stmt_poem->execute([$poetId, $title, $poem_data['poem'], $poem_data['bahr'] ?? null, $poem_data['qafiya'] ?? null]);
                $poemCount++;
            }
        }
    }
    echo "<div>ย ย ๐ ุชู ุฅุถุงูุฉ/ุชุญุฏูุซ $poemCount ูุตูุฏุฉ.</div><hr>"; flush();
}
echo "</div>";
echo "<h2>๐ ุชูุช ุนูููุฉ ุงูุงุณุชูุฑุงุฏ.</h2>";
?>